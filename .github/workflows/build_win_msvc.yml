name: build windows msvc

on:
  push:
    # tags: ['v*']
  pull_request:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - arch: x86
            msvc_arch: x86
          - arch: x64
            msvc_arch: x64
          - arch: ARM64
            msvc_arch: x64_ARM64
          - arch: ARM
            msvc_arch: x64_ARM
            sdk: 10.0.18362.0
            # x64_ARM results in following error:
            # C:\Program Files (x86)\Windows Kits\10\include\10.0.10240.0\ucrt\corecrt.h(205):
            # fatal error C1189: 
            # #error:  Compiling Desktop applications for the ARM platform is not supported.
    steps:
      - uses: actions/checkout@v4

      - name: Setup Windows SDK
        if: matrix.sdk
        uses: fbactions/setup-winsdk@v2
        with:
          winsdk-build-version: 18362

      # - name: List drive C files
      #   if: matrix.sdk
      #   run: |
      #     cmd /c dir /s /b "C:\Program Files (x86)\Windows Kits\10\include\10.0.18362.0\um"

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.msvc_arch }}
          sdk:  ${{ matrix.sdk }}

      - name: Compile resources
        run: |
          rc.exe /nologo .\batventi\batventi.rc

      - name: Build
        run: |
          cl.exe /nologo /O1 /W3 /Z7 /GF /FS /EHsc /utf-8 /MT /D "UNICODE" /D "_UNICODE" .\batventi\batventi.c .\batventi\batventi.res /link /OUT:batventi_${{ matrix.arch }}.exe

      - name: Decode PFX from Secrets
        shell: pwsh
        if: matrix.sdk
        run: |
          $pfxB64 = "${{ secrets.SIGNING_PFX_BASE64 }}"
          if ([string]::IsNullOrWhiteSpace($pfxB64)) { throw "SIGNING_PFX_BASE64 is empty" }
          $bytes = [Convert]::FromBase64String($pfxB64)
          $pfxPath = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, $bytes)
          "pfxPath=$pfxPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      
      - name: Locate signtool.exe
        id: signtool
        if: matrix.sdk
        shell: pwsh
        run: |
          $candidates = @(
            "${env:ProgramFiles(x86)}\Windows Kits\10\bin",
            "${env:ProgramFiles(x86)}\Windows Kits\11\bin"
          ) | Where-Object { Test-Path $_ }

          $signtool = $null
          foreach ($root in $candidates) {
            $signtool = Get-ChildItem -Path $root -Recurse -File -Filter "signtool.exe" -ErrorAction SilentlyContinue |
              Where-Object { $_.FullName -match "\\x64\\signtool\.exe$" } |
              Select-Object -First 1
            if ($signtool) { break }
          }

          if (-not $signtool) {
            Write-Host "signtool.exe not found under Windows Kits. Dumping common locations:"
            Get-ChildItem -Path "${env:ProgramFiles(x86)}\Windows Kits" -Recurse -File -Filter "signtool.exe" -ErrorAction SilentlyContinue |
              ForEach-Object { Write-Host $_.FullName }
            throw "signtool.exe not found"
          }

          Write-Host "signtool: $($signtool.FullName)"
          "SIGNTOOL_PATH=$($signtool.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
      
      - name: Sign EXE
        shell: pwsh
        if: matrix.sdk
        run: |
          $exe = "batventi_${{ matrix.arch }}.exe"

          & "$env:SIGNTOOL_PATH" sign `
            /f "$env:pfxPath" `
            /p "${{ secrets.SIGNING_PFX_PASSWORD }}" `
            /fd sha256 `
            /tr "http://timestamp.digicert.com" `
            /td sha256 `
            "$exe"

          # 只要“有签名”即可：用 Get-AuthenticodeSignature 看是否 Signed
          $sig = Get-AuthenticodeSignature -FilePath $exe
          Write-Host "Signature status: $($sig.Status)"
          if ($sig.Status -eq 'NotSigned') { throw "File is not signed" }

          # verify /pa 可能因为根不受信而返回 1；不让它中断流水线
          & "$env:SIGNTOOL_PATH" verify /pa "$exe"
          if ($LASTEXITCODE -ne 0) {
            Write-Warning "signtool verify failed (likely untrusted root on runner). Keeping build because signing succeeded."
            $global:LASTEXITCODE = 0
          }

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: batventi-${{ matrix.arch }}-windows
          path: batventi_${{ matrix.arch }}.exe

      - name: Prepare release
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          ren batventi_${{ matrix.arch }}.exe batventi_${{ github.ref_name }}_${{ matrix.arch }}.exe

      - name: Create release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: batventi_${{ github.ref_name }}_${{ matrix.arch }}.exe
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
